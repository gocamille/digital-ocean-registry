version: 2.1

executors:
  cci-clojure:
    docker:
      - image: cimg/clojure:1.10.1

# TODO: Add ways to save build cache

jobs:
  build-image:
    working_directory: ~/project/app
    executor: cci-clojure
    steps:
      - checkout:
          path: ~/project
      - setup_remote_docker
      - restore_cache:
         keys:
           - m2-{{ checksum "project.clj" }}
           - m2-
      - run:
          name: lein deps
          command: lein deps
      - save_cache:
          key: m2-{{ checksum "project.clj" }}
          paths:
            - ~/.m2/repository
      - run:
          name: Lein build uberjar
          command: lein uberjar
      - run:
          name: Docker Build
          command: |
            docker build . \
              --tag registry.digitalocean.com/obax/$CIRCLE_PROJECT_REPONAME:latest \
              --tag registry.digitalocean.com/obax/$CIRCLE_PROJECT_REPONAME:$CIRCLE_BUILD_NUM \
      - run: &docker-login
          name: Docker Login
          command: |
            docker login registry.digitalocean.com \
              --password $DOCKER_REGISTRY_TOKEN \
              --username $DOCKER_REGISTRY_TOKEN
      - run:
          name: Docker Push
          command: docker image push registry.digitalocean.com/obax/$CIRCLE_PROJECT_REPONAME:latest
      # - run:
      #     name: Docker Run
      #     command: docker run success

  pull-image:
    machine: true
    steps:
      - run:
          <<: *docker-login
      - run:
          name: Image pull
          command: docker pull registry.digitalocean.com/obax/success:latest

workflows:
  build-deploy:
    jobs:
      - build-image:
          filters:
            branches:
              only: main
          # requires:
          #   - build-jar
            # tags:
            #   only: \d*
      - pull-image:
          requires:
            - build-image
